const e=new class{listeners=new Map;isListening=!1;eventTypes=['click','dblclick','mousedown','mouseup','mousemove','keydown','keyup','keypress','input','change','focus','blur','submit','reset','scroll','resize','load','unload','beforeunload','message'];start(){this.isListening?console.warn('全局浏览器监听已启动'):(this.isListening=!0,this.attachWindowListeners(window),this.attachIFrameListeners(),setInterval(()=>{this.attachIFrameListeners()},2e3),console.log('✅ 全局浏览器监听已启动'))}stop(){this.isListening?(this.isListening=!1,this.listeners.clear(),console.log('✅ 全局浏览器监听已停止')):console.warn('全局浏览器监听未启动')}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const s=this.listeners.get(e),n=s.indexOf(t);n>-1&&s.splice(n,1)}attachWindowListeners(e){this.eventTypes.forEach(t=>{try{e.addEventListener(t,e=>this.handleEvent(e,!1),!0)}catch(e){console.debug(`无法监听事件: ${t}`)}})}attachIFrameListeners(){document.querySelectorAll('iframe').forEach(e=>{try{const t=e.contentDocument||e.contentWindow?.document,s=e.contentWindow;if(!t||!s)return;this.attachWindowListeners(s),s.addEventListener('message',e=>{this.handleEvent(e,!0)})}catch(e){console.debug(`无法访问 iframe: ${e}`)}})}handleEvent(e,t){const s=this.buildEventInfo(e,t),n=this.listeners.get(s.type)||[];for(const e of n)try{e(s)}catch(e){console.error('事件回调执行出错:',e)}}buildEventInfo(e,t){let s=e.target,n='',o='',i='';return s&&s instanceof HTMLElement&&(n=s.tagName.toLowerCase(),o=s.id||'',i=s.className||''),{type:e.type,target:e.target,tagName:n,elementId:o,className:i,event:e,timestamp:Date.now(),isFromIFrame:t}}getListeners(){return this.listeners}clear(){this.listeners.clear()}};const t=new class{config={enabled:!1,callbacks:[],preventDefault:!1,stopPropagation:!1};boundHandler=null;start(e){this.config.enabled?console.warn('全局点击拦截器已启动'):(this.config={...this.config,...e,enabled:!0},this.boundHandler=e=>{this.handleClick(e)},document.addEventListener('click',this.boundHandler,!0),console.log('✅ 全局点击拦截器已启动'))}stop(){this.config.enabled?(this.boundHandler&&(document.removeEventListener('click',this.boundHandler,!0),this.boundHandler=null),this.config.enabled=!1,console.log('✅ 全局点击拦截器已停止')):console.warn('全局点击拦截器未启动')}on(e){this.config.callbacks.push(e)}off(e){this.config.callbacks=this.config.callbacks.filter(t=>t!==e)}clear(){this.config.callbacks=[]}setFilter(e){this.config.filter=e}isEnabled(){return this.config.enabled}handleClick(e){const t=e.target;if(!t)return;const s=this.buildClickInfo(t,e);if(!this.config.filter||this.config.filter(s)){for(const e of this.config.callbacks)try{e(s)}catch(e){console.error('点击回调执行出错:',e)}this.config.preventDefault&&e.preventDefault(),this.config.stopPropagation&&e.stopPropagation()}}buildClickInfo(e,t){const s={};for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t];s[n.name]=n.value}const n=this.getElementPath(e),o=this.getSelectorPath(e),i=this.getCSSPath(e);return{element:e,html:e.innerHTML,text:e.innerText||e.textContent||'',attributes:s,classList:Array.from(e.classList),id:e.id,tagName:e.tagName.toLowerCase(),event:t,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,isLeftClick:0===t.button,isRightClick:2===t.button,isMiddleClick:1===t.button,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,elementPath:n,selectorPath:o,cssPath:i}}getElementPath(e){const t=[];let s=e;for(;s;)s instanceof HTMLElement&&t.unshift(s),s=s.parentElement;return t}getSelectorPath(e){const t=[];let s=e;for(;s&&s!==document.body;){let e=s.tagName.toLowerCase();s.id?e+=`#${s.id}`:s.classList.length>0&&(e+='.'+Array.from(s.classList).join('.')),t.unshift(e),s=s.parentElement}return t.join(' > ')}getCSSPath(e){const t=[];let s=e;for(;s&&s!==document.documentElement;){let e=s.tagName.toLowerCase();if(s.id){e+=`#${s.id}`,t.unshift(e);break}{let n=s.previousElementSibling,o=1;for(;n;)n.tagName.toLowerCase()===e&&o++,n=n.previousElementSibling;o>1&&(e+=`:nth-of-type(${o})`),t.unshift(e)}s=s.parentElement}return t.join(' > ')}querySelectorByPath(e){try{return document.querySelector(e)}catch{return null}}};const s='Nanyixuan';$(()=>{toastr.success('你已经成功加载示例脚本!','恭喜你!'),eventOn(getButtonEvent('重置消息'),()=>{getChatMessages('0-{{lastMessageId}}').forEach(e=>{!async function(e){console.debug(`检测到消息 ${e} 被修改，开始处理...`);const t=getChatMessages(e);if(t.length>0){const n=function(e){const t=e;var n=null;console.log(`${s}处理消息内容:`,t);const o=[];n=t.replace(/\[IMG_GEN\]([\s\S]*?)\[\/IMG_GEN\]/g,(e,t)=>(o.push(t),'')),console.log(`${s}处理消息内容后:`,n),console.log(`${s}提取到的 [IMG_GEN] 内容列表:`,o);const i=n.match(/<chat_history(?:\s+[^>]*)?>([\s\S]*?)<\/chat_history>/);if(!i||i.length<2)return console.log(`${s}未检测到 <chat_history> 标签内的内容`),{success:!1,message:'未检测到 <chat_history> 标签内的内容'};i.forEach((e,t)=>{console.log(`${s}chatHistoryContent[${t}]:`,e)});try{const e=YAML.parse(i[1]);console.log(`${s}已成功解析 <chat_history> 内容为 YAML:`,e),o.forEach((t,n)=>{console.log(`${s}处理提取到的 [IMG_GEN] 内容[${n}]:`,t);const o=t.match(/\/user\/images\/[^\s\[\]]+\.(png|jpg|jpeg|gif)/g)||[];console.log(`${s}提取到的图片链接:`,o),o.forEach((t,n)=>{const o={t:'image',c:t,time:'02:00'};e.messages.push(o),console.log(`${s}已将图片链接添加到 messages 中:`,o)})});const t=YAML.stringify(e),a=n.match(/<chat_history(\s+[^>]*)?>/),c=a?.[1]||'';return n=n.replace(/<chat_history(?:\s+[^>]*)?>([\s\S]*?)<\/chat_history>/,`<chat_history${c}>\n${t}</chat_history>`),console.log(`${s}更新后的消息内容:`,n),{success:!0,message:'已成功提取 <chat_history> 内容',updatedContent:n}}catch(e){return console.log(`${s}提取到的 <chat_history> 内容无法解析成YAML格式`),{success:!1,message:'提取到的 <chat_history> 内容无法解析成YAML格式'}}}(t[0].message);n.success&&n.updatedContent&&(await setChatMessages([{message_id:e,message:n.updatedContent}],{refresh:'affected'}),console.log(`消息 ${e} 已处理 [IMG_GEN]`))}}(e.message_id)})})}),$(window).on('pagehide',()=>{t.stop(),t.clear(),e.stop(),e.clear(),toastr.info('你已经卸载示例脚本!','再见!')});
//# sourceMappingURL=index.js.map