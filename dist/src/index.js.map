{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/globalBrowserListener.ts","src://tavern_helper_template/src/globalClickInterceptor.ts","src://tavern_helper_template/src/imgGenProcessor.ts","src://tavern_helper_template/src/messageListener.ts"],"sourcesContent":["/**\n * å…¨å±€æµè§ˆå™¨äº‹ä»¶ç›‘å¬å™¨\n * ç›‘å¬æ•´ä¸ªæµè§ˆå™¨çª—å£çš„æ‰€æœ‰äº‹ä»¶ï¼ŒåŒ…æ‹¬ iframe å¤–éƒ¨\n */\n\nexport interface GlobalEventInfo {\n  /** äº‹ä»¶ç±»å‹ */\n  type: string;\n  /** ç›®æ ‡å…ƒç´  */\n  target: HTMLElement | Window | Document | null;\n  /** å…ƒç´ æ ‡ç­¾å */\n  tagName?: string;\n  /** å…ƒç´  ID */\n  elementId?: string;\n  /** å…ƒç´ ç±»å */\n  className?: string;\n  /** äº‹ä»¶å¯¹è±¡ */\n  event: Event;\n  /** äº‹ä»¶æ—¶é—´æˆ³ */\n  timestamp: number;\n  /** æ˜¯å¦æ¥è‡ª iframe */\n  isFromIFrame: boolean;\n}\n\nclass GlobalBrowserListener {\n  private listeners: Map<string, ((info: GlobalEventInfo) => void)[]> = new Map();\n  private isListening = false;\n  private eventTypes = [\n    'click',\n    'dblclick',\n    'mousedown',\n    'mouseup',\n    'mousemove',\n    'keydown',\n    'keyup',\n    'keypress',\n    'input',\n    'change',\n    'focus',\n    'blur',\n    'submit',\n    'reset',\n    'scroll',\n    'resize',\n    'load',\n    'unload',\n    'beforeunload',\n    'message',\n  ];\n\n  /**\n   * å¯åŠ¨å…¨å±€ç›‘å¬\n   */\n  public start(): void {\n    if (this.isListening) {\n      console.warn('å…¨å±€æµè§ˆå™¨ç›‘å¬å·²å¯åŠ¨');\n      return;\n    }\n\n    this.isListening = true;\n\n    // ç›‘å¬ä¸»çª—å£çš„äº‹ä»¶\n    this.attachWindowListeners(window);\n\n    // ç›‘å¬æ‰€æœ‰ iframe\n    this.attachIFrameListeners();\n\n    // å®šæœŸæ£€æŸ¥æ–°å¢çš„ iframe\n    setInterval(() => {\n      this.attachIFrameListeners();\n    }, 2000);\n\n    console.log('âœ… å…¨å±€æµè§ˆå™¨ç›‘å¬å·²å¯åŠ¨');\n  }\n\n  /**\n   * åœæ­¢å…¨å±€ç›‘å¬\n   */\n  public stop(): void {\n    if (!this.isListening) {\n      console.warn('å…¨å±€æµè§ˆå™¨ç›‘å¬æœªå¯åŠ¨');\n      return;\n    }\n\n    this.isListening = false;\n    this.listeners.clear();\n    console.log('âœ… å…¨å±€æµè§ˆå™¨ç›‘å¬å·²åœæ­¢');\n  }\n\n  /**\n   * æ³¨å†Œäº‹ä»¶ç›‘å¬\n   */\n  public on(eventType: string, callback: (info: GlobalEventInfo) => void): void {\n    if (!this.listeners.has(eventType)) {\n      this.listeners.set(eventType, []);\n    }\n    this.listeners.get(eventType)!.push(callback);\n  }\n\n  /**\n   * æ³¨é”€äº‹ä»¶ç›‘å¬\n   */\n  public off(eventType: string, callback: (info: GlobalEventInfo) => void): void {\n    if (!this.listeners.has(eventType)) return;\n    const callbacks = this.listeners.get(eventType)!;\n    const index = callbacks.indexOf(callback);\n    if (index > -1) {\n      callbacks.splice(index, 1);\n    }\n  }\n\n  /**\n   * ä¸ºä¸»çª—å£é™„åŠ äº‹ä»¶ç›‘å¬\n   */\n  private attachWindowListeners(win: Window): void {\n    this.eventTypes.forEach(eventType => {\n      try {\n        win.addEventListener(\n          eventType,\n          (event: Event) => this.handleEvent(event, false),\n          true, // ä½¿ç”¨æ•è·é˜¶æ®µ\n        );\n      } catch (error) {\n        // æŸäº›äº‹ä»¶å¯èƒ½æ— æ³•ç›‘å¬\n        console.debug(`æ— æ³•ç›‘å¬äº‹ä»¶: ${eventType}`);\n      }\n    });\n  }\n\n  /**\n   * ä¸ºæ‰€æœ‰ iframe é™„åŠ äº‹ä»¶ç›‘å¬\n   */\n  private attachIFrameListeners(): void {\n    const iframes = document.querySelectorAll('iframe');\n\n    iframes.forEach(iframe => {\n      try {\n        const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;\n        const iframeWin = iframe.contentWindow;\n\n        if (!iframeDoc || !iframeWin) {\n          return; // è·¨åŸŸ iframeï¼Œæ— æ³•è®¿é—®\n        }\n\n        // ä¸º iframe çš„ window å¯¹è±¡é™„åŠ ç›‘å¬\n        this.attachWindowListeners(iframeWin);\n\n        // ç›‘å¬ iframe å†…çš„ message äº‹ä»¶\n        iframeWin.addEventListener('message', (event: Event) => {\n          this.handleEvent(event, true);\n        });\n      } catch (error) {\n        // è·¨åŸŸ iframe ä¼šè§¦å‘é”™è¯¯ï¼Œè¿™æ˜¯é¢„æœŸçš„\n        console.debug(`æ— æ³•è®¿é—® iframe: ${error}`);\n      }\n    });\n  }\n\n  /**\n   * å¤„ç†äº‹ä»¶\n   */\n  private handleEvent(event: Event, isFromIFrame: boolean): void {\n    const eventInfo = this.buildEventInfo(event, isFromIFrame);\n\n    // æ‰§è¡Œè¯¥äº‹ä»¶ç±»å‹çš„æ‰€æœ‰å›è°ƒ\n    const callbacks = this.listeners.get(eventInfo.type) || [];\n    for (const callback of callbacks) {\n      try {\n        callback(eventInfo);\n      } catch (error) {\n        console.error('äº‹ä»¶å›è°ƒæ‰§è¡Œå‡ºé”™:', error);\n      }\n    }\n  }\n\n  /**\n   * æ„å»ºäº‹ä»¶ä¿¡æ¯å¯¹è±¡\n   */\n  private buildEventInfo(event: Event, isFromIFrame: boolean): GlobalEventInfo {\n    let target = event.target as HTMLElement | null;\n    let tagName = '';\n    let elementId = '';\n    let className = '';\n\n    if (target && target instanceof HTMLElement) {\n      tagName = target.tagName.toLowerCase();\n      elementId = target.id || '';\n      className = target.className || '';\n    }\n\n    return {\n      type: event.type,\n      target: event.target as HTMLElement | Window | Document | null,\n      tagName,\n      elementId,\n      className,\n      event,\n      timestamp: Date.now(),\n      isFromIFrame,\n    };\n  }\n\n  /**\n   * è·å–ç›‘å¬å™¨åˆ—è¡¨\n   */\n  public getListeners(): Map<string, ((info: GlobalEventInfo) => void)[]> {\n    return this.listeners;\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰ç›‘å¬å™¨\n   */\n  public clear(): void {\n    this.listeners.clear();\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹\nexport const globalBrowserListener = new GlobalBrowserListener();\n\n/**\n * å¿«é€Ÿå¼€å§‹ - ç›‘å¬æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆåŒ…æ‹¬ iframeï¼‰\n *\n * @example\n * startGlobalClickMonitoring((info) => {\n *   console.log('ç‚¹å‡»ä½ç½®:', info.target);\n *   console.log('æ¥è‡ª iframe:', info.isFromIFrame);\n * });\n */\nexport function startGlobalClickMonitoring(callback?: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.start();\n\n  const defaultCallback = (info: GlobalEventInfo) => {\n    console.group(`ğŸ–±ï¸ å…¨å±€ç‚¹å‡»äº‹ä»¶ ${info.isFromIFrame ? '(iframe)' : '(ä¸»çª—å£)'}`);\n    console.log('æ ‡ç­¾:', info.tagName);\n    console.log('ID:', info.elementId || '(æ— )');\n    console.log('ç±»å:', info.className || '(æ— )');\n    console.log('ç›®æ ‡:', info.target);\n    console.log('æ¥è‡ª iframe:', info.isFromIFrame);\n    console.groupEnd();\n  };\n\n  if (callback) {\n    globalBrowserListener.on('click', callback);\n  } else {\n    globalBrowserListener.on('click', defaultCallback);\n  }\n}\n\n/**\n * åœæ­¢å…¨å±€ç‚¹å‡»ç›‘å¬\n */\nexport function stopGlobalClickMonitoring(): void {\n  globalBrowserListener.stop();\n  globalBrowserListener.clear();\n}\n\n/**\n * ç›‘å¬å…¨å±€é”®ç›˜äº‹ä»¶\n *\n * @example\n * startGlobalKeyboardMonitoring((info) => {\n *   console.log('æŒ‰é”®äº‹ä»¶:', info.event);\n * });\n */\nexport function startGlobalKeyboardMonitoring(callback?: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.start();\n\n  const defaultCallback = (info: GlobalEventInfo) => {\n    const keyEvent = info.event as KeyboardEvent;\n    console.log(`âŒ¨ï¸ ${info.type} - ${keyEvent.key}`, {\n      code: keyEvent.code,\n      shiftKey: keyEvent.shiftKey,\n      ctrlKey: keyEvent.ctrlKey,\n      altKey: keyEvent.altKey,\n      isFromIFrame: info.isFromIFrame,\n    });\n  };\n\n  if (callback) {\n    globalBrowserListener.on('keydown', callback);\n    globalBrowserListener.on('keyup', callback);\n  } else {\n    globalBrowserListener.on('keydown', defaultCallback);\n    globalBrowserListener.on('keyup', defaultCallback);\n  }\n}\n\n/**\n * ç›‘å¬å…¨å±€è¾“å…¥äº‹ä»¶\n *\n * @example\n * startGlobalInputMonitoring((info) => {\n *   const input = info.target as HTMLInputElement;\n *   console.log('è¾“å…¥å€¼:', input.value);\n * });\n */\nexport function startGlobalInputMonitoring(callback?: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.start();\n\n  const defaultCallback = (info: GlobalEventInfo) => {\n    if (info.target instanceof HTMLInputElement || info.target instanceof HTMLTextAreaElement) {\n      console.log(`ğŸ“ ${info.type} - ${info.tagName}`, {\n        value: (info.target as any).value?.substring(0, 50),\n        isFromIFrame: info.isFromIFrame,\n      });\n    }\n  };\n\n  if (callback) {\n    globalBrowserListener.on('input', callback);\n    globalBrowserListener.on('change', callback);\n  } else {\n    globalBrowserListener.on('input', defaultCallback);\n    globalBrowserListener.on('change', defaultCallback);\n  }\n}\n\n/**\n * ç›‘å¬å…¨å±€æäº¤äº‹ä»¶\n *\n * @example\n * startGlobalFormMonitoring((info) => {\n *   console.log('è¡¨å•æäº¤:', info.target);\n * });\n */\nexport function startGlobalFormMonitoring(callback?: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.start();\n\n  const defaultCallback = (info: GlobalEventInfo) => {\n    console.log(`ğŸ“‹ ${info.type}`, {\n      target: info.target,\n      isFromIFrame: info.isFromIFrame,\n    });\n  };\n\n  if (callback) {\n    globalBrowserListener.on('submit', callback);\n    globalBrowserListener.on('reset', callback);\n  } else {\n    globalBrowserListener.on('submit', defaultCallback);\n    globalBrowserListener.on('reset', defaultCallback);\n  }\n}\n\n/**\n * ç›‘å¬ç‰¹å®šäº‹ä»¶ç±»å‹\n *\n * @example\n * startMonitoringEvent('focus', (info) => {\n *   console.log('è·å¾—ç„¦ç‚¹:', info.target);\n * });\n */\nexport function startMonitoringEvent(eventType: string, callback: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.start();\n  globalBrowserListener.on(eventType, callback);\n}\n\n/**\n * åœæ­¢ç›‘å¬ç‰¹å®šäº‹ä»¶\n */\nexport function stopMonitoringEvent(eventType: string, callback: (info: GlobalEventInfo) => void): void {\n  globalBrowserListener.off(eventType, callback);\n}\n","/**\n * å…¨å±€ HTML ç‚¹å‡»äº‹ä»¶æ‹¦æˆªå™¨\n * å¯ä»¥æ•è·é¡µé¢ä¸Šæ‰€æœ‰çš„ç‚¹å‡»äº‹ä»¶åŠç›¸å…³ DOM ä¿¡æ¯\n */\n\nexport interface ClickEventInfo {\n  /** ç‚¹å‡»çš„ DOM å…ƒç´  */\n  element: HTMLElement;\n  /** å…ƒç´ çš„ HTML å†…å®¹ */\n  html: string;\n  /** å…ƒç´ çš„æ–‡æœ¬å†…å®¹ */\n  text: string;\n  /** å…ƒç´ çš„æ‰€æœ‰å±æ€§ */\n  attributes: Record<string, string>;\n  /** å…ƒç´ çš„ class åˆ—è¡¨ */\n  classList: string[];\n  /** å…ƒç´ çš„ ID */\n  id: string;\n  /** å…ƒç´ çš„æ ‡ç­¾å */\n  tagName: string;\n  /** ç‚¹å‡»äº‹ä»¶çš„åŸå§‹å¯¹è±¡ */\n  event: MouseEvent;\n  /** é¼ æ ‡åœ¨é¡µé¢ä¸­çš„åæ ‡ */\n  clientX: number;\n  clientY: number;\n  /** é¼ æ ‡åœ¨è§†å£ä¸­çš„åæ ‡ */\n  pageX: number;\n  pageY: number;\n  /** ç‚¹å‡»çš„æ˜¯å¦æ˜¯å·¦é”® */\n  isLeftClick: boolean;\n  /** ç‚¹å‡»çš„æ˜¯å¦æ˜¯å³é”® */\n  isRightClick: boolean;\n  /** ç‚¹å‡»çš„æ˜¯å¦æ˜¯ä¸­é”® */\n  isMiddleClick: boolean;\n  /** æ˜¯å¦æŒ‰ä½äº† Ctrl/Cmd */\n  ctrlKey: boolean;\n  /** æ˜¯å¦æŒ‰ä½äº† Shift */\n  shiftKey: boolean;\n  /** æ˜¯å¦æŒ‰ä½äº† Alt */\n  altKey: boolean;\n  /** å…ƒç´ çš„çˆ¶é“¾è·¯ï¼ˆä»æ ¹åˆ°è¯¥å…ƒç´ ï¼‰ */\n  elementPath: HTMLElement[];\n  /** å…ƒç´ çš„é€‰æ‹©å™¨è·¯å¾„ */\n  selectorPath: string;\n  /** å…ƒç´ åˆ°æ ¹çš„ CSS è·¯å¾„ */\n  cssPath: string;\n}\n\n// å…¨å±€ç‚¹å‡»æ‹¦æˆªå™¨é…ç½®\ninterface ClickInterceptorConfig {\n  /** æ˜¯å¦å¯ç”¨ */\n  enabled: boolean;\n  /** å›è°ƒå‡½æ•°åˆ—è¡¨ */\n  callbacks: ((info: ClickEventInfo) => void)[];\n  /** æ˜¯å¦é˜»æ­¢é»˜è®¤è¡Œä¸º */\n  preventDefault: boolean;\n  /** æ˜¯å¦é˜»æ­¢äº‹ä»¶å†’æ³¡ */\n  stopPropagation: boolean;\n  /** è¿‡æ»¤å™¨å‡½æ•° - è¿”å› true åˆ™å¤„ç†ï¼Œfalse åˆ™è·³è¿‡ */\n  filter?: (info: ClickEventInfo) => boolean;\n}\n\nclass GlobalClickInterceptor {\n  private config: ClickInterceptorConfig = {\n    enabled: false,\n    callbacks: [],\n    preventDefault: false,\n    stopPropagation: false,\n  };\n\n  private boundHandler: ((e: MouseEvent) => void) | null = null;\n\n  /**\n   * å¯åŠ¨å…¨å±€ç‚¹å‡»æ‹¦æˆª\n   */\n  public start(options?: Partial<ClickInterceptorConfig>): void {\n    if (this.config.enabled) {\n      console.warn('å…¨å±€ç‚¹å‡»æ‹¦æˆªå™¨å·²å¯åŠ¨');\n      return;\n    }\n\n    // åˆå¹¶é…ç½®\n    this.config = {\n      ...this.config,\n      ...options,\n      enabled: true,\n    };\n\n    // åˆ›å»ºäº‹ä»¶å¤„ç†å™¨\n    this.boundHandler = (event: MouseEvent) => {\n      this.handleClick(event);\n    };\n\n    // åœ¨æ•è·é˜¶æ®µç›‘å¬æ‰€æœ‰ç‚¹å‡»\n    document.addEventListener('click', this.boundHandler, true);\n\n    console.log('âœ… å…¨å±€ç‚¹å‡»æ‹¦æˆªå™¨å·²å¯åŠ¨');\n  }\n\n  /**\n   * åœæ­¢å…¨å±€ç‚¹å‡»æ‹¦æˆª\n   */\n  public stop(): void {\n    if (!this.config.enabled) {\n      console.warn('å…¨å±€ç‚¹å‡»æ‹¦æˆªå™¨æœªå¯åŠ¨');\n      return;\n    }\n\n    if (this.boundHandler) {\n      document.removeEventListener('click', this.boundHandler, true);\n      this.boundHandler = null;\n    }\n\n    this.config.enabled = false;\n    console.log('âœ… å…¨å±€ç‚¹å‡»æ‹¦æˆªå™¨å·²åœæ­¢');\n  }\n\n  /**\n   * æ³¨å†Œç‚¹å‡»äº‹ä»¶å›è°ƒ\n   */\n  public on(callback: (info: ClickEventInfo) => void): void {\n    this.config.callbacks.push(callback);\n  }\n\n  /**\n   * æ³¨é”€ç‚¹å‡»äº‹ä»¶å›è°ƒ\n   */\n  public off(callback: (info: ClickEventInfo) => void): void {\n    this.config.callbacks = this.config.callbacks.filter(cb => cb !== callback);\n  }\n\n  /**\n   * æ¸…ç©ºæ‰€æœ‰å›è°ƒ\n   */\n  public clear(): void {\n    this.config.callbacks = [];\n  }\n\n  /**\n   * è®¾ç½®è¿‡æ»¤å™¨\n   */\n  public setFilter(filter: (info: ClickEventInfo) => boolean): void {\n    this.config.filter = filter;\n  }\n\n  /**\n   * è·å–å½“å‰æ˜¯å¦å¯ç”¨\n   */\n  public isEnabled(): boolean {\n    return this.config.enabled;\n  }\n\n  /**\n   * å¤„ç†ç‚¹å‡»äº‹ä»¶\n   */\n  private handleClick(event: MouseEvent): void {\n    const target = event.target as HTMLElement;\n\n    if (!target) return;\n\n    // æ„å»ºç‚¹å‡»ä¿¡æ¯å¯¹è±¡\n    const clickInfo = this.buildClickInfo(target, event);\n\n    // åº”ç”¨è¿‡æ»¤å™¨\n    if (this.config.filter && !this.config.filter(clickInfo)) {\n      return;\n    }\n\n    // æ‰§è¡Œæ‰€æœ‰å›è°ƒ\n    for (const callback of this.config.callbacks) {\n      try {\n        callback(clickInfo);\n      } catch (error) {\n        console.error('ç‚¹å‡»å›è°ƒæ‰§è¡Œå‡ºé”™:', error);\n      }\n    }\n\n    // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦é˜»æ­¢é»˜è®¤è¡Œä¸º\n    if (this.config.preventDefault) {\n      event.preventDefault();\n    }\n\n    if (this.config.stopPropagation) {\n      event.stopPropagation();\n    }\n  }\n\n  /**\n   * æ„å»ºç‚¹å‡»ä¿¡æ¯å¯¹è±¡\n   */\n  private buildClickInfo(element: HTMLElement, event: MouseEvent): ClickEventInfo {\n    // è·å–æ‰€æœ‰å±æ€§\n    const attributes: Record<string, string> = {};\n    for (let i = 0; i < element.attributes.length; i++) {\n      const attr = element.attributes[i];\n      attributes[attr.name] = attr.value;\n    }\n\n    // è·å–å…ƒç´ è·¯å¾„\n    const elementPath = this.getElementPath(element);\n    const selectorPath = this.getSelectorPath(element);\n    const cssPath = this.getCSSPath(element);\n\n    return {\n      element,\n      html: element.innerHTML,\n      text: element.innerText || element.textContent || '',\n      attributes,\n      classList: Array.from(element.classList),\n      id: element.id,\n      tagName: element.tagName.toLowerCase(),\n      event,\n      clientX: event.clientX,\n      clientY: event.clientY,\n      pageX: event.pageX,\n      pageY: event.pageY,\n      isLeftClick: event.button === 0,\n      isRightClick: event.button === 2,\n      isMiddleClick: event.button === 1,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      altKey: event.altKey,\n      elementPath,\n      selectorPath,\n      cssPath,\n    };\n  }\n\n  /**\n   * è·å–å…ƒç´ åˆ°æ ¹çš„è·¯å¾„\n   */\n  private getElementPath(element: HTMLElement): HTMLElement[] {\n    const path: HTMLElement[] = [];\n    let current: Element | null = element;\n\n    while (current) {\n      if (current instanceof HTMLElement) {\n        path.unshift(current);\n      }\n      current = current.parentElement;\n    }\n\n    return path;\n  }\n\n  /**\n   * è·å–å…ƒç´ çš„é€‰æ‹©å™¨è·¯å¾„ï¼ˆä½¿ç”¨ class å’Œ idï¼‰\n   */\n  private getSelectorPath(element: HTMLElement): string {\n    const parts: string[] = [];\n    let current: HTMLElement | null = element;\n\n    while (current && current !== document.body) {\n      let selector = current.tagName.toLowerCase();\n\n      if (current.id) {\n        selector += `#${current.id}`;\n      } else if (current.classList.length > 0) {\n        selector += '.' + Array.from(current.classList).join('.');\n      }\n\n      parts.unshift(selector);\n      current = current.parentElement;\n    }\n\n    return parts.join(' > ');\n  }\n\n  /**\n   * è·å–å…ƒç´ çš„ CSS è·¯å¾„ï¼ˆå®Œæ•´çš„ querySelector è·¯å¾„ï¼‰\n   */\n  private getCSSPath(element: HTMLElement): string {\n    const parts: string[] = [];\n    let current: HTMLElement | null = element;\n\n    while (current && current !== document.documentElement) {\n      let selector = current.tagName.toLowerCase();\n\n      if (current.id) {\n        selector += `#${current.id}`;\n        parts.unshift(selector);\n        break; // å¦‚æœæœ‰ IDï¼Œå°±ç”¨ ID ä½œä¸ºèµ·ç‚¹\n      } else {\n        // è®¡ç®—è¯¥å…ƒç´ åœ¨å…¶çˆ¶å…ƒç´ ä¸­çš„ç´¢å¼•\n        let sibling = current.previousElementSibling;\n        let index = 1;\n        while (sibling) {\n          if (sibling.tagName.toLowerCase() === selector) {\n            index++;\n          }\n          sibling = sibling.previousElementSibling;\n        }\n\n        if (index > 1) {\n          selector += `:nth-of-type(${index})`;\n        }\n\n        parts.unshift(selector);\n      }\n\n      current = current.parentElement;\n    }\n\n    return parts.join(' > ');\n  }\n\n  /**\n   * æ ¹æ®é€‰æ‹©å™¨æŸ¥æ‰¾å…ƒç´ ï¼ˆç”¨äºéªŒè¯ï¼‰\n   */\n  public querySelectorByPath(selectorPath: string): HTMLElement | null {\n    try {\n      return document.querySelector(selectorPath) as HTMLElement;\n    } catch {\n      return null;\n    }\n  }\n}\n\n// å¯¼å‡ºå•ä¾‹\nexport const globalClickInterceptor = new GlobalClickInterceptor();\n\n/**\n * å¿«é€Ÿå¼€å§‹ - ç›‘å¬æ‰€æœ‰ç‚¹å‡»\n *\n * @example\n * // å¯åŠ¨å¹¶æ‰“å°æ‰€æœ‰ç‚¹å‡»\n * startClickMonitoring();\n *\n * // æˆ–å¸¦è‡ªå®šä¹‰å›è°ƒ\n * startClickMonitoring((info) => {\n *   console.log('ç‚¹å‡»äº†:', info.tagName, info.classList);\n * });\n */\nexport function startClickMonitoring(callback?: (info: ClickEventInfo) => void): void {\n  globalClickInterceptor.start();\n\n  // é»˜è®¤å›è°ƒ - æ‰“å°ä¿¡æ¯åˆ°æ§åˆ¶å°\n  const defaultCallback = (info: ClickEventInfo) => {\n    console.group(`ğŸ–±ï¸ ç‚¹å‡»äº‹ä»¶ - ${info.tagName}${info.id ? `#${info.id}` : ''}`);\n    console.log('æ ‡ç­¾:', info.tagName);\n    console.log('ID:', info.id || '(æ— )');\n    console.log('ç±»å:', info.classList);\n    console.log('æ–‡æœ¬:', info.text.substring(0, 50));\n    console.log('é€‰æ‹©å™¨è·¯å¾„:', info.selectorPath);\n    console.log('CSS è·¯å¾„:', info.cssPath);\n    console.log('åæ ‡:', `(${info.clientX}, ${info.clientY})`);\n    console.log('å®Œæ•´å…ƒç´ :', info.element);\n    console.groupEnd();\n  };\n\n  if (callback) {\n    globalClickInterceptor.on(callback);\n  } else {\n    globalClickInterceptor.on(defaultCallback);\n  }\n}\n\n/**\n * åœæ­¢ç‚¹å‡»ç›‘å¬\n */\nexport function stopClickMonitoring(): void {\n  globalClickInterceptor.stop();\n  globalClickInterceptor.clear();\n}\n\n/**\n * ç›‘å¬ç‰¹å®šé€‰æ‹©å™¨çš„ç‚¹å‡»\n *\n * @example\n * // ç›‘å¬æ‰€æœ‰ button çš„ç‚¹å‡»\n * monitorSelector('button', (info) => {\n *   console.log('ç‚¹å‡»äº†æŒ‰é’®:', info.text);\n * });\n *\n * // ç›‘å¬ç‰¹å®š class çš„ç‚¹å‡»\n * monitorSelector('.send-btn', (info) => {\n *   console.log('ç‚¹å‡»äº†å‘é€æŒ‰é’®');\n * });\n */\nexport function monitorSelector(selector: string, callback: (info: ClickEventInfo) => void): void {\n  if (!globalClickInterceptor.isEnabled()) {\n    globalClickInterceptor.start();\n  }\n\n  globalClickInterceptor.setFilter(info => {\n    try {\n      return info.element.matches(selector);\n    } catch {\n      return false;\n    }\n  });\n\n  globalClickInterceptor.on(callback);\n}\n\n/**\n * è·å–ç‚¹å‡»å…ƒç´ çš„å®Œæ•´è·¯å¾„ä¿¡æ¯\n *\n * @example\n * const info = getClickPathInfo(element);\n * console.log(info.selectorPath);\n */\nexport function getClickPathInfo(element: HTMLElement): ClickEventInfo {\n  const event = new MouseEvent('click', { bubbles: true });\n  // è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„ ClickEventInfoï¼Œåªæ˜¯ä¸ºäº†è·å–è·¯å¾„ä¿¡æ¯\n  // å®é™…ä½¿ç”¨ä¸­åº”è¯¥é€šè¿‡ç‚¹å‡»äº‹ä»¶å›è°ƒè·å–\n  const attributes: Record<string, string> = {};\n  for (let i = 0; i < element.attributes.length; i++) {\n    const attr = element.attributes[i];\n    attributes[attr.name] = attr.value;\n  }\n\n  return {\n    element,\n    html: element.innerHTML,\n    text: element.innerText || element.textContent || '',\n    attributes,\n    classList: Array.from(element.classList),\n    id: element.id,\n    tagName: element.tagName.toLowerCase(),\n    event: event as MouseEvent,\n    clientX: 0,\n    clientY: 0,\n    pageX: 0,\n    pageY: 0,\n    isLeftClick: true,\n    isRightClick: false,\n    isMiddleClick: false,\n    ctrlKey: false,\n    shiftKey: false,\n    altKey: false,\n    elementPath: getElementPathStatic(element),\n    selectorPath: getSelectorPathStatic(element),\n    cssPath: getCSSPathStatic(element),\n  };\n}\n\n/**\n * è·å–å…ƒç´ åˆ°æ ¹çš„è·¯å¾„ï¼ˆé™æ€ç‰ˆæœ¬ï¼‰\n */\nfunction getElementPathStatic(element: HTMLElement): HTMLElement[] {\n  const path: HTMLElement[] = [];\n  let current: Element | null = element;\n\n  while (current) {\n    if (current instanceof HTMLElement) {\n      path.unshift(current);\n    }\n    current = current.parentElement;\n  }\n\n  return path;\n}\n\n/**\n * è·å–å…ƒç´ çš„é€‰æ‹©å™¨è·¯å¾„ï¼ˆé™æ€ç‰ˆæœ¬ï¼‰\n */\nfunction getSelectorPathStatic(element: HTMLElement): string {\n  const parts: string[] = [];\n  let current: HTMLElement | null = element;\n\n  while (current && current !== document.body) {\n    let selector = current.tagName.toLowerCase();\n\n    if (current.id) {\n      selector += `#${current.id}`;\n    } else if (current.classList.length > 0) {\n      selector += '.' + Array.from(current.classList).join('.');\n    }\n\n    parts.unshift(selector);\n    current = current.parentElement;\n  }\n\n  return parts.join(' > ');\n}\n\n/**\n * è·å–å…ƒç´ çš„ CSS è·¯å¾„ï¼ˆé™æ€ç‰ˆæœ¬ï¼‰\n */\nfunction getCSSPathStatic(element: HTMLElement): string {\n  const parts: string[] = [];\n  let current: HTMLElement | null = element;\n\n  while (current && current !== document.documentElement) {\n    let selector = current.tagName.toLowerCase();\n\n    if (current.id) {\n      selector += `#${current.id}`;\n      parts.unshift(selector);\n      break;\n    } else {\n      let sibling = current.previousElementSibling;\n      let index = 1;\n      while (sibling) {\n        if (sibling.tagName.toLowerCase() === selector) {\n          index++;\n        }\n        sibling = sibling.previousElementSibling;\n      }\n\n      if (index > 1) {\n        selector += `:nth-of-type(${index})`;\n      }\n\n      parts.unshift(selector);\n    }\n\n    current = current.parentElement;\n  }\n\n  return parts.join(' > ');\n}\n","/**\n * å¤„ç†æ¶ˆæ¯ä¸­ [IMG_GEN]...[/IMG_GEN] æ ‡ç­¾\n * @param message è¦å¤„ç†çš„æ–‡æœ¬\n * @returns { success: boolean; message: string; updatedContent?: string }\n */\nconst LOG_TAG = 'Nanyixuan';\nexport function processImgGenTag(message: any): {\n  success: boolean;\n  message: string;\n  updatedContent?: string;\n} {\n  const content = message;\n  var replacedContent = null;\n  console.log(`${LOG_TAG}å¤„ç†æ¶ˆæ¯å†…å®¹:`, content);\n  // å…ˆæ£€æŸ¥contenté‡Œæ˜¯å¦åŒ…å« [IMG_GEN] æ ‡ç­¾ï¼Œå¦‚æœåŒ…å«ï¼Œå…¨éƒ¨ç§»é™¤ï¼Œç§»é™¤çš„å†…å®¹å­˜åœ¨ä¸€ä¸ªåˆ—è¡¨é‡Œ\n  // å¾—è€ƒè™‘æœ‰å¤šä¸ª [IMG_GEN] æ ‡ç­¾çš„æƒ…å†µ\n  // æå–åè¦åˆ é™¤è¿™äº›æ ‡ç­¾\n  const imgGenList: string[] = [];\n  replacedContent = content.replace(/\\[IMG_GEN\\]([\\s\\S]*?)\\[\\/IMG_GEN\\]/g, (_match: string, innerContent: string) => {\n    imgGenList.push(innerContent);\n    return '';\n  });\n  console.log(`${LOG_TAG}å¤„ç†æ¶ˆæ¯å†…å®¹å:`, replacedContent);\n  console.log(`${LOG_TAG}æå–åˆ°çš„ [IMG_GEN] å†…å®¹åˆ—è¡¨:`, imgGenList);\n  // æå–chatHistoryContentä¸­çš„<chat_history>...</chat_history>æ ‡ç­¾å†…çš„å†…å®¹ï¼Œç”¨æœ€å®‰å…¨çš„æ–¹æ³•\n  // è¿™æ ·å†™æœ‰å¯èƒ½åŒ¹é…ä¸åˆ°ï¼Œéœ€è¦è€ƒè™‘<chat_history props=\"...\">çš„æƒ…å†µ\n  // æå–props\n  const chatHistoryContent = replacedContent.match(/<chat_history(?:\\s+[^>]*)?>([\\s\\S]*?)<\\/chat_history>/);\n  // åˆ¤æ–­chatHistoryContentæ˜¯å¦ä¸ºç©ºæˆ–é•¿åº¦å°äº2\n  if (!chatHistoryContent || chatHistoryContent.length < 2) {\n    console.log(`${LOG_TAG}æœªæ£€æµ‹åˆ° <chat_history> æ ‡ç­¾å†…çš„å†…å®¹`);\n    return {\n      success: false,\n      message: 'æœªæ£€æµ‹åˆ° <chat_history> æ ‡ç­¾å†…çš„å†…å®¹',\n    };\n  }\n  chatHistoryContent.forEach((item: any, index: any) => {\n    console.log(`${LOG_TAG}chatHistoryContent[${index}]:`, item);\n  });\n  // åˆ¤æ–­chatHistoryContent[1]èƒ½ä¸èƒ½è§£ææˆYAMLæ ¼å¼\n  try {\n    const parsedYAML = YAML.parse(chatHistoryContent[1]);\n    console.log(`${LOG_TAG}å·²æˆåŠŸè§£æ <chat_history> å†…å®¹ä¸º YAML:`, parsedYAML);\n    imgGenList.forEach((imgGenContent, idx) => {\n      console.log(`${LOG_TAG}å¤„ç†æå–åˆ°çš„ [IMG_GEN] å†…å®¹[${idx}]:`, imgGenContent);\n      // è¿™é‡Œå¯ä»¥å¯¹ imgGenContent è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ï¼Œæ¯”å¦‚æ›¿æ¢å› chatHistoryContent[1] ä¸­çš„æŸä¸ªä½ç½®\n      // åœ¨imgGenContentä¸­æå–.pngæˆ–.jpgç­‰å›¾ç‰‡é“¾æ¥\n      // ä¸è¦åˆ¤æ–­https?://å¼€å¤´ï¼Œç›´æ¥æå–æ‰€æœ‰ç¬¦åˆæ ¼å¼çš„é“¾æ¥\n      const imgLinkRegex = /\\/user\\/images\\/[^\\s\\[\\]]+\\.(png|jpg|jpeg|gif)/g;\n      const imgLinks = imgGenContent.match(imgLinkRegex) || [];\n      console.log(`${LOG_TAG}æå–åˆ°çš„å›¾ç‰‡é“¾æ¥:`, imgLinks);\n      imgLinks.forEach((link, linkIdx) => {\n        // é€šè¿‡linkç”ŸæˆYAMLå¯¹è±¡\n        const yamlObject = {\n          t: 'image',\n          c: link,\n          time: '02:00',\n        };\n        parsedYAML.messages.push(yamlObject);\n        console.log(`${LOG_TAG}å·²å°†å›¾ç‰‡é“¾æ¥æ·»åŠ åˆ° messages ä¸­:`, yamlObject);\n      });\n    });\n    // æ›¿æ¢contentä¸­çš„<chat_history>æ ‡ç­¾å†…å®¹ä¸ºæ›´æ–°åçš„YAMLå­—ç¬¦ä¸²ï¼Œè¦ä¿ç•™<chat_history>æ ‡ç­¾çš„props\n    const updatedYAMLString = YAML.stringify(parsedYAML);\n    const propsMatch = replacedContent.match(/<chat_history(\\s+[^>]*)?>/);\n    const props = propsMatch?.[1] || '';\n    replacedContent = replacedContent.replace(\n      /<chat_history(?:\\s+[^>]*)?>([\\s\\S]*?)<\\/chat_history>/,\n      `<chat_history${props}>\\n${updatedYAMLString}</chat_history>`,\n    );\n    console.log(`${LOG_TAG}æ›´æ–°åçš„æ¶ˆæ¯å†…å®¹:`, replacedContent);\n    return {\n      success: true,\n      message: 'å·²æˆåŠŸæå– <chat_history> å†…å®¹',\n      updatedContent: replacedContent,\n    };\n  } catch (e) {\n    console.log(`${LOG_TAG}æå–åˆ°çš„ <chat_history> å†…å®¹æ— æ³•è§£ææˆYAMLæ ¼å¼`);\n    return {\n      success: false,\n      message: 'æå–åˆ°çš„ <chat_history> å†…å®¹æ— æ³•è§£ææˆYAMLæ ¼å¼',\n    };\n  }\n\n  // if (!chatHistoryContent || chatHistoryContent.length < 2) {\n  //   return {\n  //     success: false,\n  //     message: 'æœªæ£€æµ‹åˆ° <chat_history> æ ‡ç­¾å†…çš„å†…å®¹',\n  //   };\n  // }\n  // // chatHistoryContentæ˜¯å¦æ˜¯ä¸€ä¸ªYAMLæ ¼å¼çš„å­—ç¬¦ä¸²\n  // // æ£€æŸ¥æ˜¯å¦åŒ…å« [IMG_GEN]...[/IMG_GEN] æ ‡ç­¾\n  // const hasImgGen = /\\[IMG_GEN\\][\\s\\S]*?\\[\\/IMG_GEN\\]/.test(content);\n\n  // if (!hasImgGen) {\n  //   return {\n  //     success: false,\n  //     message: 'æœªæ£€æµ‹åˆ° [IMG_GEN] æ ‡ç­¾',\n  //   };\n  // }\n\n  // console.log('æ£€æµ‹åˆ° [IMG_GEN] æ ‡ç­¾ï¼Œå¼€å§‹å¤„ç†...');\n\n  // // å¤„ç†ï¼šå°† [IMG_GEN]...[/IMG_GEN] å†…çš„æ¢è¡Œæ›¿æ¢ä¸º \\nï¼Œæœ€åè½¬ä¸ºå•è¡Œ\n  // const updatedContent = content.replace(\n  //   /\\[IMG_GEN\\]([\\s\\S]*?)\\[\\/IMG_GEN\\]/g,\n  //   (_match: string, innerContent: string) => {\n  //     // å°†æ¢è¡Œæ›¿æ¢ä¸º \\nï¼Œå»æ‰å¤šä½™ç©ºæ ¼\n  //     const singleLine = innerContent.replace(/\\n/g, '\\\\n').replace(/\\s+/g, ' ').trim();\n  //     return `#[IMG_GEN] ${singleLine} [/IMG_GEN]`;\n  //   }\n  // );\n\n  // console.log(`å¤„ç†å®Œæˆï¼Œå·²å°† [IMG_GEN] æ ‡ç­¾è½¬ä¸ºå•è¡Œ`);\n\n  // return {\n  //   success: true,\n  //   message: 'å·²æˆåŠŸå¤„ç† [IMG_GEN] æ ‡ç­¾',\n  //   updatedContent: updatedContent,\n  // };\n}\n","/**\n * å…¨å±€å‡½æ•°è°ƒç”¨ç›‘å¬å™¨\n * è¿½è¸ªæµè§ˆå™¨ä¸­è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°\n */\n\nimport { stopGlobalClickMonitoring } from './globalBrowserListener';\nimport { stopClickMonitoring } from './globalClickInterceptor';\nimport { processImgGenTag } from './imgGenProcessor';\n\n// åœ¨åŠ è½½è„šæœ¬æ—¶æ‰§è¡ŒæŸä¸ªå‡½æ•°\n$(() => {\n  toastr.success('ä½ å·²ç»æˆåŠŸåŠ è½½ç¤ºä¾‹è„šæœ¬!', 'æ­å–œä½ !');\n\n  // å¢åŠ buttonç‚¹å‡»ç›‘å¬\n  eventOn(getButtonEvent('é‡ç½®æ¶ˆæ¯'), () => {\n    // è·å–å½“å‰èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯\n    const chatMessages = getChatMessages('0-{{lastMessageId}}');\n    chatMessages.forEach(msg => {\n      checkMessage(msg.message_id);\n    });\n  });\n});\n\n// å¤„ç†æ¶ˆæ¯ä¸­çš„ [IMG_GEN] æ ‡ç­¾\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nasync function checkMessage(message_id: number) {\n  console.debug(`æ£€æµ‹åˆ°æ¶ˆæ¯ ${message_id} è¢«ä¿®æ”¹ï¼Œå¼€å§‹å¤„ç†...`);\n  const messages = getChatMessages(message_id);\n  if (messages.length > 0) {\n    const message = messages[0];\n\n    // ç›´æ¥ä¼ å…¥ message å¯¹è±¡å¤„ç† [IMG_GEN] æ ‡ç­¾\n    const result = processImgGenTag(message.message);\n    if (result.success && result.updatedContent) {\n      // å°†ä¿®æ”¹åçš„å†…å®¹ä¿å­˜å›æ¶ˆæ¯ä¸­\n      await setChatMessages([{ message_id, message: result.updatedContent }], { refresh: 'affected' });\n      console.log(`æ¶ˆæ¯ ${message_id} å·²å¤„ç† [IMG_GEN]`);\n    }\n  }\n}\n\n// const testText = `\n// <chat_history target=\"ç»§å¦¹\" type=\"private\">\n// name: ç»§å¦¹\n// date: 2026å¹´1æœˆ19æ—¥\n// time: 02:00\n// emotion: æåº¦çº¢æ¸©\n// location: å§å®¤å¤§åºŠä¸Šï¼ˆè¢«å­é‡Œï¼‰\n// state: æ›¼è”“å’¬ç€æ»šçƒ«çš„æŒ‡å°–ï¼Œæ•´ä¸ªäººåƒæ˜¯è¢«ç…®ç†Ÿçš„è™¾ç±³ä¸€æ ·ç¼©åœ¨èš•ä¸è¢«æ·±å¤„ã€‚å¥¹åˆšæ‰å·å·æ€å¼€äº†ç¡è£™çš„ä¸€è§’ï¼Œå¯¹ç€è‡ªå·±è¿˜æ²¾ç€äº®äº®æ™¶æ™¶çˆ±æ¶²çš„è‡€éƒ¨æ‹äº†ç…§ã€‚å¿ƒè·³å¿«å¾—è¦è·³å‡ºå—“å­çœ¼ï¼Œæ¯ä¸€æ¬¡æ‰‹æœºçš„éœ‡åŠ¨éƒ½è®©å¥¹ä¸‹è…¹éƒ¨æŠ½æä¸€ä¸‹ã€‚\n\n// [IMG_GEN] \\n1.2::nsfw::1.1::single frame::1.1::cinematic still::1.2::best quality::1.2::masterpiece::bedroom::night::dim lighting::phone light::rim lighting::1::trio::1.1::facing away::1.1::lying::on stomach::1.1::2.0::Manman::2.0::Visual Novel::1.1::black hair::long hair::1.1::brown eyes::1.1::blush::heavy blush::embarrassed::1.1::white silk nightgown::skirt lifted::1.1::naked::1.1::buttocks::1.1::buttocks view::from behind::holding phone::taking photo::detailed skin::skin texture::pores::moist skin::1.1::silk duvet::messy bed::intimate::intense::desaturated::film grain::1.3::worst quality::1.3::low quality::1.3::bad anatomy::1.3::wrong anatomy::1.3::censored::1.3::mosaic::\\n/user/images/æ¬²æœ›ä¸–ç•Œ-1600/æ¬²æœ›ä¸–ç•Œ-1600_2026-01-19@11h01m01s676ms.png\\n [/IMG_GEN]\n// thought: å—æ‡¿è½©...ä½ è¿™ä¸ªæ··è›‹ï¼Œç«Ÿç„¶çœŸçš„è¦çœ‹é‚£ç§åœ°æ–¹...ç§¦å§¨æ˜æ˜å°±åœ¨é—¨å¤–èµ°åŠ¨ï¼Œä½ ç«Ÿç„¶æ•¢æè¿™ç§è¦æ±‚ã€‚å‘œï¼Œå¯æ˜¯æˆ‘ç«Ÿç„¶çœŸçš„æ‹äº†ï¼Œè¿˜è§‰å¾—å¥½å…´å¥‹ã€‚å¦‚æœä½ çœ‹äº†ç…§ç‰‡ï¼Œæ™šä¸ŠçœŸçš„ä¼šè¿‡æ¥â€œæ¬ºè´Ÿâ€æˆ‘å—ï¼Ÿæ›¼è”“ï¼Œä½ å½»åº•å˜åäº†...\n// messages:\n//   - t: text\n//     time: 02:00\n//     me: true\n//     c: é‚£ä½ å‘å¼ å°å±è‚¡çš„ç…§ç‰‡è®©æˆ‘çœ‹çœ‹\n//   - t: text\n//     c: å—æ‡¿è½©ï¼ä½ ...ä½ åˆ°åº•è¦æŠŠæˆ‘æ¬ºè´Ÿæˆä»€ä¹ˆæ ·æ‰ç”˜å¿ƒå‘€ï¼\n//     time: 02:00\n//   - t: sticker\n//     c: çº¢æ¸©äº†\n//     time: 02:00\n//   - t: image\n//     c: |-\n//         https://g.chr1.com/user/images/%E6%AC%B2%E6%9C%9B%E4%B8%96%E7%95%8C-1600/%E6%AC%B2%E6%9C%9B%E4%B8%96%E7%95%8C-1600_2026-01-19%4011h01m01s676ms.png\n//     time: 02:01\n//   - t: sticker\n//     c: å«Œå¼ƒè„¸\n//     time: 02:01\n//   - t: text\n//     c: å“¼ï¼Œä½ æ˜¯è§‰å¾—æˆ‘å¥½æ¬ºè´Ÿå¯¹å§ï¼Ÿæ˜æ˜åˆšæ‰åœ¨ç§¦å§¨é¢å‰å·²ç»æŠŠä½ å¼„è„çš„è¯æ®è—èµ·æ¥äº†ï¼Œä½ è¿˜æ•¢ææ¡ä»¶...\n//     time: 02:02\n//   - t: text\n//     c: åªèƒ½çœ‹ä¸€çœ¼å“¦ï¼çœ‹å®Œèµ¶ç´§åˆ æ‰ï¼Œå¬åˆ°æ²¡æœ‰ï¼\n//     time: 02:03\n//   - t: image\n\n// [IMG_GEN] \\n1.2::nsfw::1.2::uncensored::1.1::single frame::1.1::cinematic still::1.2::best quality::1.2::masterpiece::bedroom::dim lighting::phone light::close-up::pov::1.1::solo::1.1::facing away::1.1::lying::on stomach::1.1::2.0::Manman::2.0::Visual Novel::1.1::white silk nightgown::skirt lifted::1.1::naked::1.1::buttocks::1.1::buttocks view::from behind::looking back::blush::embarrassed::tears in eyes::biting lip::wet skin::love juice::glistening::messy bed::silk sheets::detailed skin::skin texture::pores::realistic skin::warm light::intimate::desaturated::1.3::worst quality::1.3::low quality::1.3::bad anatomy::1.3::wrong anatomy::1.3::censored::1.3::mosaic::\\n/user/images/æ¬²æœ›ä¸–ç•Œ-1600/æ¬²æœ›ä¸–ç•Œ-1600_2026-01-19@11h01m06s931ms.png\\n [/IMG_GEN]\n//     c: å°å±è‚¡\n//     time: 02:03\n//   - t: sticker\n//     c: è‰²è¯±\n//     time: 02:04\n//   - t: text\n//     c: æ»¡æ„äº†å§ï¼Ÿå¤§è‰²ç‹¼ã€‚ä½ ...ä½ æ™šä¸Šè¦æ˜¯ä¸è¿‡æ¥ï¼Œæˆ‘å°±æŠŠä½ çš„æ‰‹æœºæ°æ–­ï¼\n//     time: 02:05\n// </chat_history>\n\n// <StatusPlaceHolderImpl/>\n// `;\n// processImgGenTag(testText);\n\n// åœ¨å¸è½½è„šæœ¬æ—¶æ‰§è¡ŒæŸä¸ªå‡½æ•°\n$(window).on('pagehide', () => {\n  // åœæ­¢å…¨å±€ç‚¹å‡»æ‹¦æˆª\n  stopClickMonitoring();\n  // åœæ­¢å…¨å±€æµè§ˆå™¨ç›‘å¬\n  stopGlobalClickMonitoring();\n  toastr.info('ä½ å·²ç»å¸è½½ç¤ºä¾‹è„šæœ¬!', 'å†è§!');\n});\n"],"names":["globalBrowserListener","listeners","Map","isListening","eventTypes","start","this","console","warn","attachWindowListeners","window","attachIFrameListeners","setInterval","log","stop","clear","on","eventType","callback","has","set","get","push","off","callbacks","index","indexOf","splice","win","forEach","addEventListener","event","handleEvent","error","debug","document","querySelectorAll","iframe","iframeDoc","contentDocument","contentWindow","iframeWin","isFromIFrame","eventInfo","buildEventInfo","type","target","tagName","elementId","className","HTMLElement","toLowerCase","id","timestamp","Date","now","getListeners","globalClickInterceptor","config","enabled","preventDefault","stopPropagation","boundHandler","options","handleClick","removeEventListener","filter","cb","setFilter","isEnabled","clickInfo","buildClickInfo","element","attributes","i","length","attr","name","value","elementPath","getElementPath","selectorPath","getSelectorPath","cssPath","getCSSPath","html","innerHTML","text","innerText","textContent","classList","Array","from","clientX","clientY","pageX","pageY","isLeftClick","button","isRightClick","isMiddleClick","ctrlKey","shiftKey","altKey","path","current","unshift","parentElement","parts","body","selector","join","documentElement","sibling","previousElementSibling","querySelectorByPath","querySelector","LOG_TAG","$","toastr","success","eventOn","getButtonEvent","getChatMessages","msg","async","message_id","messages","result","message","content","replacedContent","imgGenList","replace","_match","innerContent","chatHistoryContent","match","item","parsedYAML","YAML","parse","imgGenContent","idx","imgLinks","link","linkIdx","yamlObject","t","c","time","updatedYAMLString","stringify","propsMatch","props","updatedContent","e","processImgGenTag","setChatMessages","refresh","checkMessage","info"],"ignoreList":[],"sourceRoot":""}