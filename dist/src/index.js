const e=new class{listeners=new Map;isListening=!1;eventTypes=['click','dblclick','mousedown','mouseup','mousemove','keydown','keyup','keypress','input','change','focus','blur','submit','reset','scroll','resize','load','unload','beforeunload','message'];start(){this.isListening?console.warn('全局浏览器监听已启动'):(this.isListening=!0,this.attachWindowListeners(window),this.attachIFrameListeners(),setInterval(()=>{this.attachIFrameListeners()},2e3),console.log('✅ 全局浏览器监听已启动'))}stop(){this.isListening?(this.isListening=!1,this.listeners.clear(),console.log('✅ 全局浏览器监听已停止')):console.warn('全局浏览器监听未启动')}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const s=this.listeners.get(e),n=s.indexOf(t);n>-1&&s.splice(n,1)}attachWindowListeners(e){this.eventTypes.forEach(t=>{try{e.addEventListener(t,e=>this.handleEvent(e,!1),!0)}catch(e){console.debug(`无法监听事件: ${t}`)}})}attachIFrameListeners(){document.querySelectorAll('iframe').forEach(e=>{try{const t=e.contentDocument||e.contentWindow?.document,s=e.contentWindow;if(!t||!s)return;this.attachWindowListeners(s),s.addEventListener('message',e=>{this.handleEvent(e,!0)})}catch(e){console.debug(`无法访问 iframe: ${e}`)}})}handleEvent(e,t){const s=this.buildEventInfo(e,t),n=this.listeners.get(s.type)||[];for(const e of n)try{e(s)}catch(e){console.error('事件回调执行出错:',e)}}buildEventInfo(e,t){let s=e.target,n='',i='',o='';return s&&s instanceof HTMLElement&&(n=s.tagName.toLowerCase(),i=s.id||'',o=s.className||''),{type:e.type,target:e.target,tagName:n,elementId:i,className:o,event:e,timestamp:Date.now(),isFromIFrame:t}}getListeners(){return this.listeners}clear(){this.listeners.clear()}};const t=new class{config={enabled:!1,callbacks:[],preventDefault:!1,stopPropagation:!1};boundHandler=null;start(e){this.config.enabled?console.warn('全局点击拦截器已启动'):(this.config={...this.config,...e,enabled:!0},this.boundHandler=e=>{this.handleClick(e)},document.addEventListener('click',this.boundHandler,!0),console.log('✅ 全局点击拦截器已启动'))}stop(){this.config.enabled?(this.boundHandler&&(document.removeEventListener('click',this.boundHandler,!0),this.boundHandler=null),this.config.enabled=!1,console.log('✅ 全局点击拦截器已停止')):console.warn('全局点击拦截器未启动')}on(e){this.config.callbacks.push(e)}off(e){this.config.callbacks=this.config.callbacks.filter(t=>t!==e)}clear(){this.config.callbacks=[]}setFilter(e){this.config.filter=e}isEnabled(){return this.config.enabled}handleClick(e){const t=e.target;if(!t)return;const s=this.buildClickInfo(t,e);if(!this.config.filter||this.config.filter(s)){for(const e of this.config.callbacks)try{e(s)}catch(e){console.error('点击回调执行出错:',e)}this.config.preventDefault&&e.preventDefault(),this.config.stopPropagation&&e.stopPropagation()}}buildClickInfo(e,t){const s={};for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t];s[n.name]=n.value}const n=this.getElementPath(e),i=this.getSelectorPath(e),o=this.getCSSPath(e);return{element:e,html:e.innerHTML,text:e.innerText||e.textContent||'',attributes:s,classList:Array.from(e.classList),id:e.id,tagName:e.tagName.toLowerCase(),event:t,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,isLeftClick:0===t.button,isRightClick:2===t.button,isMiddleClick:1===t.button,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,elementPath:n,selectorPath:i,cssPath:o}}getElementPath(e){const t=[];let s=e;for(;s;)s instanceof HTMLElement&&t.unshift(s),s=s.parentElement;return t}getSelectorPath(e){const t=[];let s=e;for(;s&&s!==document.body;){let e=s.tagName.toLowerCase();s.id?e+=`#${s.id}`:s.classList.length>0&&(e+='.'+Array.from(s.classList).join('.')),t.unshift(e),s=s.parentElement}return t.join(' > ')}getCSSPath(e){const t=[];let s=e;for(;s&&s!==document.documentElement;){let e=s.tagName.toLowerCase();if(s.id){e+=`#${s.id}`,t.unshift(e);break}{let n=s.previousElementSibling,i=1;for(;n;)n.tagName.toLowerCase()===e&&i++,n=n.previousElementSibling;i>1&&(e+=`:nth-of-type(${i})`),t.unshift(e)}s=s.parentElement}return t.join(' > ')}querySelectorByPath(e){try{return document.querySelector(e)}catch{return null}}};$(()=>{toastr.success('你已经成功加载示例脚本!','恭喜你!'),eventOn(getButtonEvent('重置消息'),()=>{getChatMessages('0-{{lastMessageId}}').forEach(e=>{!async function(e){console.debug(`检测到消息 ${e} 被修改，开始处理...`);const t=getChatMessages(e);if(t.length>0){const s=function(e){const t=e.message;if(!/\[IMG_GEN\][\s\S]*?\[\/IMG_GEN\]/.test(t))return{success:!1,message:'未检测到 [IMG_GEN] 标签'};console.log('检测到 [IMG_GEN] 标签，开始处理...');const s=t.replace(/\[IMG_GEN\]([\s\S]*?)\[\/IMG_GEN\]/g,(e,t)=>`#[IMG_GEN] ${t.replace(/\n/g,'\\n').replace(/\s+/g,' ').trim()} [/IMG_GEN]`);return console.log('处理完成，已将 [IMG_GEN] 标签转为单行'),{success:!0,message:'已成功处理 [IMG_GEN] 标签',updatedContent:s}}(t[0]);s.success&&s.updatedContent&&(await setChatMessages([{message_id:e,message:s.updatedContent}],{refresh:'affected'}),console.log(`消息 ${e} 已处理 [IMG_GEN]`))}}(e.message_id)})})}),$(window).on('pagehide',()=>{t.stop(),t.clear(),e.stop(),e.clear(),toastr.info('你已经卸载示例脚本!','再见!')});
//# sourceMappingURL=index.js.map